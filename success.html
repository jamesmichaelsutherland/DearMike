<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thank you â€” Dear Mike</title>
  <style>
    body{ background:#000; color:#fff; font-family: "IBM Plex Mono", monospace; padding:28px; }
    p{ color:#bdbdbd; font-size:16px }
  </style>
</head>
<body>
  <h2>Thank you!</h2>
  <p id="statusText">Processing your message...</p>

<script>
(function(){
  const APPS_SCRIPT_WEBHOOK = "https://script.google.com/macros/s/AKfycbzb6pcahAq5YeDTQcF6317vO7m5M7YPMTgFE51IJ8kcvdFDyy7xeFGxKi_emfQ8ytRXVQ/exec";
  const CLIENT_SECRET = "supersecretstring123";
  const statusEl = document.getElementById('statusText');

  async function markPaid(messageId){
    try {
      // Send a simple POST (no custom headers to avoid preflight)
      const res = await fetch(APPS_SCRIPT_WEBHOOK, {
        method: 'POST',
        body: JSON.stringify({
          clientSecret: CLIENT_SECRET,
          markPaid: true,
          messageId: messageId
        })
      });

      const raw = await res.text();
      console.log("Raw response on success page:", raw);

      let data;
      try {
        data = JSON.parse(raw);
      } catch (e) {
        console.error("Could not parse Apps Script response on success page:", e, raw);
        statusEl.textContent = "Unexpected server response. Please copy your message manually if needed.";
        return;
      }

      console.log("Parsed Apps Script response (success page):", data);

      if (data && data.success) {
        statusEl.textContent = "Your message has been sent successfully.";
        // Clear the stored messageId
        try { sessionStorage.removeItem("dearMike_messageId"); } catch(e){}
      } else if (data && data.error) {
        statusEl.textContent = "Error verifying your message: " + String(data.error);
      } else {
        statusEl.textContent = "Unexpected response from server. Your message may have been sent.";
      }
    } catch (err) {
      console.error("Fetch error on success page:", err);
      statusEl.textContent = "Network error while verifying your message: " + (err && err.message ? err.message : String(err));
    }
  }

  // run on load
  window.addEventListener("load", function(){
    let messageId = null;
    try { messageId = sessionStorage.getItem("dearMike_messageId"); } catch(e){ console.warn("sessionStorage access error", e); }

    if (!messageId) {
      statusEl.textContent = "Your message was processed, but we could not verify it automatically. Please copy it manually if needed.";
      return;
    }

    // If messageId is empty string, still attempt markPaid (Apps Script may accept it),
    // otherwise call markPaid
    markPaid(messageId);
  });
})();
</script>
</body>
</html>
