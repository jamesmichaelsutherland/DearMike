<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Message Sent — Dear Mike</title>
<style>
  :root{ --bg:#000; --fg:#fff; --muted:#bdbdbd; }
  html,body{margin:0;padding:0;height:100%;display:flex;align-items:center;justify-content:center;background:var(--bg);color:var(--fg);font-family:"IBM Plex Mono",ui-monospace,monospace;text-align:center;}
  .card{max-width:600px;padding:32px;}
  h1{font-size:26px;margin-bottom:16px;}
  p{font-size:16px;color:var(--muted);}
  .loading{animation:pulse 1.4s ease-in-out infinite alternate;}
  @keyframes pulse {from{opacity:.3;}to{opacity:1;}}
</style>
</head>
<body>
  <div class="card">
    <h1 id="title">Sending your message…</h1>
    <p id="desc" class="loading">Please wait a moment.</p>
  </div>

<script>
const APPS_SCRIPT_WEBHOOK = "https://script.google.com/macros/s/AKfycbwo1GEHilGv42FiD7sWZyAsBI7GAp_rtvCUiNxq4_OA-EYJceZrHQ8HaQK22kMNvj9eBg/exec";
const APPS_SCRIPT_CLIENT_SECRET = "supersecretstring123";
const LOCAL_STORAGE_KEY = "dearMike_pending_v1";

async function sendPendingMessage() {
  const title = document.getElementById('title');
  const desc = document.getElementById('desc');
  
  let pending;
  try {
    pending = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY));
  } catch(e) {
    pending = null;
  }

  if (!pending || !pending.message) {
    title.textContent = "No pending message found.";
    desc.textContent = "If you already paid, your message might have already been sent successfully. You can safely close this page.";
    desc.classList.remove("loading");
    return;
  }

  try {
    const response = await fetch(APPS_SCRIPT_WEBHOOK, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        name: pending.name,
        email: pending.email,
        message: pending.message,
        ts: pending.ts,
        clientSecret: APPS_SCRIPT_CLIENT_SECRET
      })
    });

    const data = await response.json();

    if (data.success) {
      title.textContent = "Thank you — your message has been sent!";
      desc.textContent = "Mike will receive it shortly. You may now close this page.";
      desc.classList.remove("loading");
      localStorage.removeItem(LOCAL_STORAGE_KEY);
    } else {
      throw new Error(data.error || "Unknown error");
    }
  } catch(err) {
    title.textContent = "Something went wrong.";
    desc.textContent = "Your payment was successful, but we couldn’t send your message automatically. Please copy your message and send it manually.";
    desc.classList.remove("loading");
    console.error(err);
  }
}

document.addEventListener("DOMContentLoaded", sendPendingMessage);
</script>
</body>
</html>
